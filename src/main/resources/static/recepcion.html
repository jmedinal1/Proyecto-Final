<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Recepción - Sistema de Turnos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <style>
        body { padding-top: 20px; }
        .card { margin-bottom: 20px; }
    </style>
</head>
<body class="bg-light">
<div class="container">
    <h1 class="mb-4">Recepción - Sistema de Turnos</h1>

    <!-- Crear paciente -->
    <div class="card">
        <div class="card-header">Registrar nuevo paciente</div>
        <div class="card-body">
            <form id="formCrearPaciente" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label" for="pacNombre">Nombre</label>
                    <input type="text" id="pacNombre" class="form-control" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label" for="pacSintomas">Síntomas</label>
                    <input type="text" id="pacSintomas" class="form-control">
                </div>
                <div class="col-md-4">
                    <label class="form-label" for="pacPrioridad">Prioridad</label>
                    <select id="pacPrioridad" class="form-select" required>
                        <option value="">Seleccione...</option>
                        <option value="1">1 - Alta</option>
                        <option value="2">2 - Media</option>
                        <option value="3">3 - Baja</option>
                    </select>
                </div>
                <div class="col-12 d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary">Guardar paciente</button>
                </div>
            </form>
            <div id="msgPaciente" class="mt-3"></div>
        </div>
    </div>

    <!-- Lista de pacientes -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Pacientes registrados</span>
            <button id="btnRefrescarPacientes" class="btn btn-sm btn-outline-secondary">
                Actualizar lista
            </button>
        </div>
        <div class="card-body">
            <table class="table table-sm table-striped">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Síntomas</th>
                    <th>Prioridad</th>
                </tr>
                </thead>
                <tbody id="tablaPacientes">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Crear turno para paciente -->
    <div class="card">
        <div class="card-header">Asignar turno a paciente</div>
        <div class="card-body">
            <form id="formCrearTurno" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label" for="turnoNumero">Número de turno</label>
                    <input type="number" id="turnoNumero" class="form-control" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="turnoArea">Área</label>
                    <select id="turnoArea" class="form-select" required>
                        <option value="">Seleccione...</option>
                        <option value="EMERGENCIA">Emergencia</option>
                        <option value="CONSULTA_EXTERNA">Consulta externa</option>
                        <option value="LABORATORIO">Laboratorio</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="turnoPacienteId">ID Paciente</label>
                    <input type="number" id="turnoPacienteId" class="form-control" required>
                    <div class="form-text">Use un ID de la tabla de pacientes.</div>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-success w-100">
                        Crear turno
                    </button>
                </div>
            </form>
            <div id="msgTurno" class="mt-3"></div>
        </div>
    </div>

</div>

<script>
    const API = 'http://localhost:8080';

    function showMsg(id, text, type = 'success') {
        const div = document.getElementById(id);
        div.innerHTML = `<div class="alert alert-${type} py-2 mb-0">${text}</div>`;
    }

    // Crear paciente
    document.getElementById('formCrearPaciente').addEventListener('submit', async (e) => {
        e.preventDefault();
        const body = {
            nombre: document.getElementById('pacNombre').value,
            sintomas: document.getElementById('pacSintomas').value,
            prioridad: parseInt(document.getElementById('pacPrioridad').value, 10)
        };

        try {
            const r = await fetch(API + '/api/pacientes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (!r.ok) {
                const txt = await r.text();
                showMsg('msgPaciente', 'Error al crear paciente: ' + txt, 'danger');
                return;
            }

            const data = await r.json();
            showMsg('msgPaciente', 'Paciente creado con ID ' + data.id);
            document.getElementById('formCrearPaciente').reset();
            cargarPacientes();

        } catch (err) {
            console.error(err);
            showMsg('msgPaciente', 'Error de conexión.', 'danger');
        }
    });

    // Lista de pacientes
    async function cargarPacientes() {
        try {
            const r = await fetch(API + '/api/pacientes');
            const lista = await r.json();
            const tbody = document.getElementById('tablaPacientes');
            tbody.innerHTML = '';

            if (!Array.isArray(lista) || lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Sin pacientes</td></tr>';
                return;
            }

            lista.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p.id}</td>
                    <td>${p.nombre}</td>
                    <td>${p.sintomas ?? ''}</td>
                    <td>${p.prioridad}</td>
                `;
                tbody.appendChild(tr);
            });

        } catch (err) {
            console.error(err);
        }
    }

    document.getElementById('btnRefrescarPacientes').addEventListener('click', cargarPacientes);

    // Crear turno para paciente
    document.getElementById('formCrearTurno').addEventListener('submit', async (e) => {
        e.preventDefault();

        const body = {
            numero: parseInt(document.getElementById('turnoNumero').value, 10),
            area: document.getElementById('turnoArea').value,
            paciente: { id: parseInt(document.getElementById('turnoPacienteId').value, 10) }
        };

        try {
            const r = await fetch(API + '/api/turnos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (!r.ok) {
                const txt = await r.text();
                showMsg('msgTurno', 'Error al crear turno: ' + txt, 'danger');
                return;
            }

            const data = await r.json();
            showMsg('msgTurno', 'Turno creado. ID: ' + data.id);
            document.getElementById('formCrearTurno').reset();

        } catch (err) {
            console.error(err);
            showMsg('msgTurno', 'Error de conexión.', 'danger');
        }
    });

    window.addEventListener('load', cargarPacientes);
</script>
</body>
</html>

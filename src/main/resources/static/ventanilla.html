<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Ventanilla - Sistema de Turnos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <style>
        body { padding-top: 20px; }
        .card { margin-bottom: 20px; }
        .turno-num { font-weight: bold; font-size: 1.1rem; }
    </style>
</head>
<body class="bg-light">
<div class="container">
    <h1 class="mb-4">Ventanilla - Atención de Turnos</h1>

    <!-- Selección de área -->
    <div class="card">
        <div class="card-header">Área de atención</div>
        <div class="card-body">
            <form id="formArea" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label" for="areaVentanilla">Área</label>
                    <select id="areaVentanilla" class="form-select" required>
                        <option value="">Seleccione...</option>
                        <option value="EMERGENCIA">Emergencia</option>
                        <option value="CONSULTA_EXTERNA">Consulta externa</option>
                        <option value="LABORATORIO">Laboratorio</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-outline-secondary">
                        Ver cola
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Cola de turnos -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Turnos en espera en el área</span>
            <button id="btnRefrescarCola" class="btn btn-sm btn-outline-secondary">
                Actualizar
            </button>
        </div>
        <div class="card-body">
            <table class="table table-sm table-striped">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Número</th>
                    <th>Paciente</th>
                    <th>Prioridad</th>
                    <th>Estado</th>
                </tr>
                </thead>
                <tbody id="tablaCola">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Llamar siguiente -->
    <div class="card">
        <div class="card-header">Llamar siguiente turno</div>
        <div class="card-body">
            <button id="btnLlamar" class="btn btn-success">
                Llamar siguiente en el área seleccionada
            </button>
            <div id="msgLlamar" class="mt-3"></div>
        </div>
    </div>
</div>

<script>
    const API = 'http://localhost:8080';

    function showMsg(id, text, type = 'success') {
        document.getElementById(id).innerHTML =
            `<div class="alert alert-${type} py-2 mb-0">${text}</div>`;
    }

    let areaActual = '';

    async function cargarCola() {
        if (!areaActual) return;

        try {
            const r = await fetch(API + '/api/turnos/area/' + areaActual);
            const lista = await r.json();
            const tbody = document.getElementById('tablaCola');
            tbody.innerHTML = '';

            // solo EN_ESPERA
            const enEspera = lista.filter(t => t.estado === 'EN_ESPERA');

            if (enEspera.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Sin turnos en espera</td></tr>';
                return;
            }

            enEspera.forEach(t => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${t.id}</td>
                    <td class="turno-num">${t.numero}</td>
                    <td>${t.paciente ? t.paciente.nombre : '-'}</td>
                    <td>${t.paciente ? t.paciente.prioridad : '-'}</td>
                    <td>${t.estado}</td>
                `;
                tbody.appendChild(tr);
            });

        } catch (err) {
            console.error(err);
        }
    }

    document.getElementById('formArea').addEventListener('submit', (e) => {
        e.preventDefault();
        areaActual = document.getElementById('areaVentanilla').value;
        cargarCola();
    });

    document.getElementById('btnRefrescarCola').addEventListener('click', cargarCola);

    document.getElementById('btnLlamar').addEventListener('click', async () => {
        if (!areaActual) {
            showMsg('msgLlamar', 'Seleccione un área primero.', 'warning');
            return;
        }

        try {
            const r = await fetch(API + '/api/turnos/llamar/' + areaActual, {
                method: 'POST'
            });

            if (r.status === 404) {
                showMsg('msgLlamar', 'No hay turnos en espera para esa área.', 'warning');
                return;
            }
            if (!r.ok) {
                showMsg('msgLlamar', 'Error al llamar turno.', 'danger');
                return;
            }

            const turno = await r.json();
            showMsg('msgLlamar',
                `Turno llamado: ${turno.numero} - Paciente: ${turno.paciente ? turno.paciente.nombre : 'N/A'}`,
                'success');

            cargarCola();

        } catch (err) {
            console.error(err);
            showMsg('msgLlamar', 'Error de conexión.', 'danger');
        }
    });
</script>
</body>
</html>

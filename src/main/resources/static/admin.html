<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Administración de Turnos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #f5f7fa; padding-top: 20px; }
        .kpi-card { font-size: 1.6rem; font-weight: bold; }
        .chart-container { height: 300px; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-primary px-3">
    <a class="navbar-brand" href="recepcion.html">
        Sistema de Turnos
    </a>

    <div class="d-flex align-items-center gap-2">
        <!-- Botones de navegación -->
        <a href="recepcion.html" class="btn btn-light btn-sm">
            Recepción
        </a>

        <a href="ventanilla.html" class="btn btn-outline-light btn-sm">
            Ventanilla
        </a>

        <a href="pantalla.html" class="btn btn-outline-light btn-sm">
            Pantalla
        </a>

        <a href="admin.html" class="btn btn-warning btn-sm">
            Admin
        </a>

        <!-- Info del usuario -->
        <span id="infoUsuario" class="text-white mx-3"></span>

        <!-- Cerrar sesión -->
        <button class="btn btn-outline-light btn-sm" onclick="logout()">
            Cerrar sesión
        </button>
    </div>
</nav>


<div class="container">
    <h1 class="mb-4">Dashboard de Administración</h1>

    <!-- KPIs -->
    <div class="row mb-4">

        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h6>En espera</h6>
                    <div id="kpiEspera" class="kpi-card text-primary">0</div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h6>Atendidos</h6>
                    <div id="kpiAtendidos" class="kpi-card text-success">0</div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h6>Cancelados</h6>
                    <div id="kpiCancelados" class="kpi-card text-danger">0</div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h6>Total del día</h6>
                    <div id="kpiHoy" class="kpi-card">0</div>
                </div>
            </div>
        </div>

    </div>

    <!-- Gráfica por área -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header">Turnos por área</div>
        <div class="card-body chart-container">
            <canvas id="chartAreas"></canvas>
        </div>
    </div>

    <!-- Gráfica por prioridad -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header">Pacientes por prioridad</div>
        <div class="card-body chart-container">
            <canvas id="chartPrioridad"></canvas>
        </div>
    </div>

</div>

<script>
    const API = "http://localhost:8080";

    let chartAreas, chartPrioridad;

    async function cargarKPIs() {
        const r = await fetch(API + "/api/turnos/estadisticas/general");
        const data = await r.json();

        document.getElementById("kpiEspera").textContent = data.totalEnEspera;
        document.getElementById("kpiAtendidos").textContent = data.totalAtendidos;
        document.getElementById("kpiCancelados").textContent = data.totalCancelados;
        document.getElementById("kpiHoy").textContent = data.turnosDeHoy;
    }

    async function cargarGraficaAreas() {
        const r = await fetch(API + "/api/turnos/estadisticas/por-area");
        const data = await r.json();

        const labels = Object.keys(data);
        const valores = Object.values(data);

        if (chartAreas) chartAreas.destroy();

        chartAreas = new Chart(document.getElementById("chartAreas"), {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: "Turnos",
                    data: valores,
                    backgroundColor: ["#0d6efd", "#198754", "#ffc107"]
                }]
            }
        });
    }

    async function cargarGraficaPrioridad() {
        const r = await fetch(API + "/api/turnos/estadisticas/prioridad");
        const data = await r.json();

        const labels = ["Prioridad 1", "Prioridad 2", "Prioridad 3"];
        const valores = [
            data.prioridad1,
            data.prioridad2,
            data.prioridad3
        ];

        if (chartPrioridad) chartPrioridad.destroy();

        chartPrioridad = new Chart(document.getElementById("chartPrioridad"), {
            type: 'pie',
            data: {
                labels,
                datasets: [{
                    data: valores,
                    backgroundColor: ["#dc3545", "#ffc107", "#198754"]
                }]
            }
        });
    }

    async function actualizarTodo() {
        cargarKPIs();
        cargarGraficaAreas();
        cargarGraficaPrioridad();
    }

    window.addEventListener("load", () => {
        actualizarTodo();
        setInterval(actualizarTodo, 5000); // refresco automático
    });
</script>

</body>
</html>
